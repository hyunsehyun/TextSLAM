# NavOCR-SLAM 논문 작성용 알고리즘 설명

## 1. 시스템 개요

NavOCR-SLAM은 OCR 기반 텍스트 간판을 랜드마크로 활용하는 시각적 SLAM 시스템입니다.

### 1.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                      Input Layer                            │
├─────────────────────────────────────────────────────────────┤
│  • OCR Detection (NavOCR)  → 텍스트 + 바운딩박스 + 신뢰도   │
│  • Depth Image (RealSense) → 깊이 정보                      │
│  • Camera Info             → 카메라 내부 파라미터           │
│  • Odometry (rtabmap)      → 카메라 위치/자세               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   Processing Layer                          │
├─────────────────────────────────────────────────────────────┤
│  1. 3D 위치 추정 (깊이 + 카메라 모델)                        │
│  2. 데이터 연관 (마할라노비스 거리 + 텍스트 유사도)          │
│  3. 랜드마크 업데이트 (Welford 온라인 알고리즘)              │
│  4. 랜드마크 병합 (중복 제거)                                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      Output Layer                           │
├─────────────────────────────────────────────────────────────┤
│  • 랜드마크 맵 (3D 위치 + 텍스트)                           │
│  • RViz 시각화 마커                                         │
│  • Reprojection Error 평가                                  │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 데이터 구조

**Landmark 구조:**

| 기호 | 설명 |
|------|------|
| μ ∈ ℝ³ | 3D 평균 위치 (월드 좌표계) |
| Σ ∈ ℝ³ˣ³ | 공분산 행렬 |
| N | 관측 횟수 |
| T | 대표 텍스트 (가중 투표로 결정) |
| c | 텍스트 신뢰도 (0~1) |

---

## 2. 3D 위치 추정 (Depth Projection)

### 2.1 핀홀 카메라 모델

바운딩박스 중심 (u, v)와 깊이 z를 이용해 카메라 좌표계에서 3D 점을 계산:

```
P_camera = [ (u - cx) * z / fx ]
           [ (v - cy) * z / fy ]
           [         z         ]
```

**변수 설명:**

| 기호 | 설명 |
|------|------|
| (fx, fy) | 초점 거리 (픽셀 단위) |
| (cx, cy) | 주점 (principal point) |
| z | 깊이 값 (미터) |

### 2.2 월드 좌표 변환

TF를 통해 카메라 → 월드 좌표계 변환:

```
P_world = R · P_camera + t
```

| 기호 | 설명 |
|------|------|
| R | 회전 행렬 (3×3) |
| t | 이동 벡터 (3×1) |

---

## 3. 데이터 연관 (Data Association)

새로운 관측을 기존 랜드마크와 연관시키는 핵심 알고리즘입니다.

### 3.1 마할라노비스 거리 (Mahalanobis Distance)

공분산을 고려한 통계적 거리 측정:

```
d²_mahal = (p - μ)ᵀ Σ⁻¹ (p - μ)
```

| 기호 | 설명 |
|------|------|
| p | 새로운 관측 위치 |
| μ | 랜드마크 평균 위치 |
| Σ | 랜드마크 공분산 행렬 |

**χ² 게이트 (99% 신뢰도):**

```
d²_mahal < χ²(3, 0.99) = 13.5
```

### 3.2 텍스트 유사도 (Text Similarity)

#### Levenshtein Distance (편집 거리)

두 문자열 간 최소 편집 연산 수 (삽입, 삭제, 치환)를 계산합니다.

**기본 케이스:**
- L(i, 0) = i (첫 번째 문자열만 있는 경우)
- L(0, j) = j (두 번째 문자열만 있는 경우)

**재귀 관계:**
```
L(i,j) = min { L(i-1, j) + 1      (삭제)
             { L(i, j-1) + 1      (삽입)
             { L(i-1, j-1) + δ    (치환)
```

여기서 δ = 0 (문자 일치 시), δ = 1 (문자 불일치 시)

**정규화된 유사도:**

```
sim_lev = 1.0 - L(s1, s2) / max(|s1|, |s2|)
```

#### 추가 보너스

**1. 부분 문자열 보너스** (OCR이 간판 일부만 인식한 경우):
```
sim_substr = 0.25 × |s_short| / |s_long|
```

**2. 접두사 보너스** (첫 3-4글자 일치):
```
sim_prefix = 0.10
```

**최종 텍스트 유사도:**
```
sim_text = min(1.0, sim_lev + sim_substr + sim_prefix)
```

### 3.3 복합 스코어 (Combined Score)

기하학적 거리와 텍스트 유사도를 결합:

```
score = w_geo · s_geo + w_text · s_text
```

| 기호 | 수식 | 설명 |
|------|------|------|
| s_geo | 1.0 - d²_mahal / χ²_threshold | 기하학적 스코어 |
| s_text | sim_text | 텍스트 스코어 |
| w_geo | 0.9 | 기하학적 가중치 |
| w_text | 0.1 | 텍스트 가중치 |

**연관 결정:**
- score > 0.55 → 기존 랜드마크에 연관 → 업데이트
- score ≤ 0.55 → 새로운 랜드마크 생성

---

## 4. 랜드마크 업데이트 (Welford's Online Algorithm)

### 4.1 온라인 평균 업데이트

새로운 관측이 들어올 때마다 평균을 점진적으로 업데이트:

```
μ_new = μ_old + (p_new - μ_old) / N
```

여기서 N은 현재까지의 총 관측 수

**장점:**
- O(1) 메모리 (모든 관측 저장 불필요)
- 수치적 안정성 (직접 평균 계산보다 오차 적음)
- 실시간 처리 가능

### 4.2 초기 공분산 설정

```
Σ₀ = [ σ²   0    0   ]
     [ 0    σ²   0   ]
     [ 0    0   9σ²  ]
```

여기서 σ = 0.3m (센서 노이즈)

> Z축(깊이)은 3배 더 큰 불확실성 반영

---

## 5. 대표 텍스트 선정 (Weighted Voting)

OCR 노이즈에 강건한 텍스트 결정 방식:

### 5.1 가중 투표

각 텍스트별 OCR 신뢰도 합산:

```
score(T) = Σ conf_i   (for all i where text_i = T)
```

### 5.2 대표 텍스트 및 신뢰도

```
T_rep = argmax_T score(T)

confidence = score(T_rep) / Σ score(T)
```

> **Sliding Window**: 최근 50개 관측만 유지 (시간에 따른 적응)

---

## 6. 랜드마크 병합 (Duplicate Removal)

동일 간판이 여러 랜드마크로 생성되는 것을 방지합니다.

### 6.1 병합 조건

두 조건 **모두** 만족 시 병합:

| 조건 | 수식 |
|------|------|
| 유클리드 거리 | ‖μ₁ - μ₂‖ < 1.0m |
| 텍스트 유사도 | sim_text > 0.3 |

### 6.2 병합 시 위치 업데이트

관측 수 가중 평균:

```
μ_merged = (N₁ · μ₁ + N₂ · μ₂) / (N₁ + N₂)

N_merged = N₁ + N₂
```

---

## 7. 재투영 오차 (Reprojection Error)

### 7.1 재투영 공식

3D 랜드마크를 이미지 평면으로 재투영:

**Step 1: 월드 → 카메라 좌표 변환**
```
P_camera = Rᵀ · (P_world - t_camera)
```

**Step 2: 카메라 → 이미지 좌표 투영**
```
u_proj = fx · P_camera_x / P_camera_z + cx

v_proj = fy · P_camera_y / P_camera_z + cy
```

### 7.2 오차 계산

```
e = √[(u_proj - u_obs)² + (v_proj - v_obs)²]
```

단위: **픽셀**

> **필터링**: e > 50 픽셀이면 잘못된 연관으로 간주하여 제외

---

## 8. 주요 파라미터

| 파라미터 | 값 | 설명 |
|----------|-----|------|
| χ² threshold | 13.5 | 마할라노비스 거리 임계값 (99% 신뢰도) |
| Text similarity threshold | 0.35 | 최소 텍스트 유사도 |
| Acceptance threshold | 0.55 | 데이터 연관 최소 스코어 |
| Sensor noise σ | 0.3m | 깊이 센서 표준편차 |
| Merge radius | 10.0m | 병합 탐색 반경 |
| Min observations | 3 | 출력 최소 관측 수 |
| Text history size | 50 | 텍스트 투표용 윈도우 크기 |
| Geo:Text weight | 90:10 | 복합 스코어 가중치 |

---

## 9. 핵심 수식 요약 (논문용)

| 구성요소 | 수식 |
|----------|------|
| 마할라노비스 거리 | d² = (p - μ)ᵀ Σ⁻¹ (p - μ) |
| 텍스트 유사도 | sim = 1 - L(s₁, s₂) / max(\|s₁\|, \|s₂\|) + bonus |
| 복합 스코어 | score = 0.9 · s_geo + 0.1 · s_text |
| 온라인 평균 | μ_new = μ_old + (p - μ_old) / N |
| 재투영 오차 | e = √[(u_proj - u_obs)² + (v_proj - v_obs)²] |
| 가중 병합 | μ = (N₁μ₁ + N₂μ₂) / (N₁ + N₂) |
